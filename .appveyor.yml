# ABOUT
# Appveyor CI configuration to build Artisan install packages
#     for Windows, Windows legacy, macOS, and Linux
#
# LICENSE
# This program or module is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 2 of the License, or
# version 3 of the License, or (at your option) any later versison. It is
# provided for educational purposes and is distributed in the hope that
# it will be useful, but WITHOUT ANY WARRANTY; without even the implied
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See
# the GNU General Public License for more details.
#
# AUTHOR
# Dave Baxter, Marko Luther 2023

# Include "skip ci" in the commit message to prevent this build process from running
environment:
  # Set the default Appveyor Python version here. Does not affect windows_legacy. Can be overridden in platform environment.
  PYTHON_V: 3.13
  matrix:
  - job_name: windows_legacy
    appveyor_build_worker_image: Visual Studio 2019
  - job_name: windows
    appveyor_build_worker_image: Visual Studio 2022
  - job_name: macos
    appveyor_build_worker_image: macos-monterey
  - job_name: linux
    appveyor_build_worker_image: Ubuntu2204

# (rest of the file omitted for brevity)

-
  matrix:
    only:
      - job_name: raspberrypi_arm64
    fast_finish: false

  appveyor_build_worker_image: Ubuntu2204  # Using Ubuntu image as closest approximation; ARM64 cross-compilation assumed

  environment:
    ARTISAN_OS: raspberrypi_arm64
    ARCH: arm64
    PYTHON_V: 3.11
    PYTHONSITEPKGS: /home/appveyor/venv${PYTHON_V}/lib/python${PYTHON_V}/site-packages
    QT_PATH: $PYTHON_PATH/PyQt6/Qt6
    QT_SRC_PATH: /home/appveyor/Qt/6.4/gcc_64
    PYUIC: pyuic6
    PYLUPDATE: ./pylupdate6pro.py
    CROSS_COMPILE: "arm-linux-gnueabihf"

  install:
    - echo "Raspberry Pi ARM64 Install"
    - chmod +x .ci/*.sh

    # update the __revision__ field with the left seven of the GIT commit hash
    - export GIT_VERSION=`git rev-parse --verify --short HEAD 2>/dev/null || echo "???"`
    - sed -i'' -e "s/__revision__ = '.*'/__revision__ = '$GIT_VERSION'/" src/artisanlib/__init__.py

    # Run install script with ARM64 considerations
    - .ci/install-rpi.sh

  build_script:
    - echo "Raspberry Pi ARM64 Build"
    - chmod +x src/*.sh
    - cd src

    # Run the build script for ARM64
    - ./build-linux-rpi.sh

  artifacts:
    - path: 'src/%artifact_prefix%-rpi-arm64.deb'
    - path: 'src/%artifact_prefix%-rpi-arm64.tar.gz'

  deploy_script:
    - ../.ci/upload.sh artisan-*-rpi-arm64.deb
    - ../.ci/upload.sh artisan-*-rpi-arm64.tar.gz
